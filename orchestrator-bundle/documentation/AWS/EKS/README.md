
# Deploying Magma Orc8r on: AWS with EKS

The goal of this document is to detail how to deploy Magma's Orchestrator on AWS. To do so,
we will deploy charmed Kubernetes on AWS, deploy Magma Orchestrator on Kubernetes and create
DNS A records.

### Prerequisites

You will need access to a Ubuntu 20.04 machine. On this machine, make sure you have the 
following software installed:
- [Juju](https://juju.is/docs/olm/installing-juju)
- [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/)
- [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
- [eksctl](https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html)

You will also need an AWS account. From your Ubuntu machine, you will need to be logged in 
to your account via the AWS CLI tool (instructions 
[here](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-quickstart.html)).

![Alt text](images/pre_requisites_eks.png?raw=true "Title")


## 1. Register a domain

Orchestrator is a web service, which means you will need a domain. You can either use one that you
already own or purchase one via your domain registrar of choice. In this example we will use a 
domain purchased from Google Domains and refer to it as `<your domain>`.

## 2. Deploy Kubernetes on AWS using EKS

You can deploy a Kubernetes cluster on AWS using EKS following the official guide 
[here](https://juju.is/docs/olm/amazon-elastic-kubernetes-service-(amazon-eks)#heading--install-the-juju-client).
At the end, you should have a EKS cluster running, a Juju controller created, and a Juju model.

## 3. Deploy charmed magma orchestrator

To deploy magma-orc8r, you will first need to create an `overlay.yaml` file that contains the following:

```yaml
applications:
  orc8r-certifier:
    options:
      domain: <your domain name>
```
Replace `<your domain name>` with your domain name.

Deploy orchestrator:

```bash
juju deploy magma-orc8r --overlay overlay.yaml --trust --channel=edge
```

You can retrieve the deployment status using `juju status`. The deployment is completed when
all services are in the `Active-Idle` state.

## 4. Import the HTTPS Certificate
In this example we are using self-signed certificates. This means that You will need to import a 
certificate in your browser for it to trust traffic coming from Orchestrator. First retrieve the 
certificate that was generated by the `orc8r-certifier` service:

```bash
juju scp orc8r-certifier/0:/tmp/certs/admin_operator.pfx admin_operator.pfx
```

Then import this file in your browser. For Chrome, this is done by navigating to: 
Settings -> Security and Privacy -> Manage Certificates -> Your Certificates -> Import. You 
will be asked for the certificate's password, which is `password123`. This password can be changed 
by deploying the certifier charm using the Juju config `passphrase`.

## 5. Setup Orchestrator

The NMS requires some basic certificate-based authentication when making calls to the Orchestrator 
API. To support this, we need to add the relevant certificate as an admin user to the controller.

```bash
juju run-action orc8r-orchestrator/0 create-orchestrator-admin-user
```

Create an admin user for the master organization on the NMS:

```bash
juju run-action nms-magmalte/0 create-nms-admin-user email=<admin email> password=<admin password>
```

Replace `<admin email>` and `<admin password>` with your email and password of choice.

## 6. DNS Resolution

### i. Configure Route53

Route53 is AWS's domain name service. We will use it to create a hosted zone for our domain name
and four A records for the following subdomains:
- `*.nms.<your domain>` 
- `bootstrapper-controller.<your domain>`
- `controller.<your domain>`
- `api.<your domain>`

This can easily be done using the provided script. Navigate to the 
`documentation/AWS/utils/route53_integrator` directory and run:

```bash
pip3 install -r requirements.txt
python3 route53_integrator --hosted_zone=<your domain> --namespace <your model>
```

### ii. Configure DNS records

You will need to configure your DNS records on your managed domain name to use the Route53 
nameservers in order to resolve these subdomains. 

In this example, our domain is registered with Google Domains. To configure our DNS records, 
head to Google Domains -> DNS -> Custom Name Servers. Fill in 4 Name Server boxes with the domains 
retrieved from the `route53_integrator` script. Make sure that your domain is using these settings. If it isn't, you will
be prompted with a warning telling you "Your domain isn't using these settings". If that's the 
case click on **Switch to these settings**.

## 7. Verify the deployment

After a few minutes the NS records should propagate. Confirm successful deployment by visiting the 
master NMS organization at e.g. `https://master.nms.<your domain>` and logging in 
with the `<admin email>` and `<admin password>` provided above.

For interacting with the Orchestrator REST API, a good starting point is the Swagger UI available 
at `https://api.<your domain>/swagger/v1/ui/`.

If desired, you can also visit the AWS endpoints directly. The relevant services are nginx-proxy 
for NMS and orc8r-nginx-proxy for Orchestrator API. Remember to include https://, as well as the 
port number for non-standard TLS ports.
